<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL MAP 2.0//EN"
"http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="employee">
	<insert id="insert" parameterClass="prime.admin.employee.EmployeeBean">
		INSERT INTO EMPLOYEES
		(EMPLOYEE_ID , EMPLOYEE_NAME, ADDRESS, CONTACT_NUMBER, EMAIL,
		 BIRTHDATE, GENDER, HIRE_DATE, DIVISION_ID, POSITION_ID,
		 HEAD_ID) VALUES 
		(#employeeId#, #employeeName#, #address#, #contactNumber#, #email#, #birthdate#, 
		 #gender#, #hireDate#, 
		<isEqual property="divisionId" compareValue="0">
			null
		</isEqual>
		<isNotEqual property="divisionId" compareValue="0">
			#divisionId#
		</isNotEqual>
		 , #positionId#, 
		 <isEqual property="managerId" compareValue="0">
			null
		</isEqual>
		<isNotEqual property="managerId" compareValue="0">
			#managerId#
		</isNotEqual>
		 )
	</insert>
	
	<insert id="insertResign" parameterClass="prime.admin.employee.EmployeeBean">
		INSERT INTO RESIGN_EMPLOYEES
		(EMPLOYEE_ID , RESIGN_DATE, RESIGN_NOTE) VALUES 
		(#employeeId#, #resignDate#, #resignNote#)
	</insert>
	
	<update id="updateStatusUser" parameterClass="java.lang.Integer">
		UPDATE USERS SET
		STATUS_USER = 0
		WHERE EMPLOYEE_ID=$employeeId$ 
	</update>
	
	<insert id="insertWeekend" parameterClass="prime.admin.employee.EmployeeBean">
		INSERT INTO WEEKEND_HOLIDAYS
		(EMPLOYEE_ID , START_FROM, WEEKEND, WEEKEND_NOTE) VALUES 
		(#employeeId#, #startFrom#, #weekEnd#,#descriptionWeekEnd#)
	</insert>
	
	<update id="updateWeekend" parameterClass="prime.admin.employee.EmployeeBean">
		UPDATE WEEKEND_HOLIDAYS SET
		WEEKEND=#weekEnd#,
		WEEKEND_NOTE=#descriptionWeekEnd#
		WHERE EMPLOYEE_ID=#employeeId# AND START_FROM = #startFrom#
	</update>
	
	<insert id="insertDayoff" parameterClass="prime.admin.employee.EmployeeBean">
		INSERT INTO DAY_OFFS
		(EMPLOYEE_ID , DAYOFF_START_DATE, DAYOFF_END_DATE, DAYOFF_NOTE) VALUES 
		(#employeeId#, #startDate#, #endDate#,#descriptionDayOff#)
	</insert>
	
	<update id="update" parameterClass="prime.admin.employee.EmployeeBean">
		UPDATE EMPLOYEES SET
		EMPLOYEE_NAME=#employeeName#,
		ADDRESS=#address#,
		CONTACT_NUMBER=#contactNumber#,
		EMAIL=#email#,
		BIRTHDATE=#birthdate#,
		GENDER=#gender#,
		HIRE_DATE=#hireDate#
		WHERE EMPLOYEE_ID=#employeeId#
	</update>
	
	<update id="updatePositionDivision" parameterClass="prime.admin.employee.EmployeeBean">
		UPDATE EMPLOYEES SET
		<isEqual property="divisionId" compareValue="0">
			DIVISION_ID=NULL,
		</isEqual>
		<isNotEqual property="divisionId" compareValue="0">
			DIVISION_ID=#divisionId#,
		</isNotEqual>
		POSITION_ID=#positionId#,
		<isNotEqual property="managerId"  compareValue="0">
			HEAD_ID=#managerId#
		</isNotEqual>
		<isEqual property="managerId"  compareValue="0">
			HEAD_ID=null
		</isEqual>
		WHERE EMPLOYEE_ID=#employeeId#
	</update>
	
	<update id="updateHead" parameterClass="java.util.Map">
		UPDATE EMPLOYEES SET
		HEAD_ID=#newHead#
		WHERE HEAD_ID=#forCondition#
	</update>
	
	<select id="getNewId" resultClass="java.lang.Integer">
		SELECT NVL(MAX(EMPLOYEE_ID)+1, 1) FROM EMPLOYEES
	</select>
	
	<select id="get"  resultClass="prime.admin.employee.EmployeeBean" parameterClass="java.lang.Integer">
		SELECT 
	        EMP.EMPLOYEE_ID AS employeeId, 
	        EMP.EMPLOYEE_NAME AS employeeName,
	        GENDER AS gender,
	        ADDRESS AS address,
	        BIRTHDATE AS birthdate,
	        HIRE_DATE AS hireDate,
	        CONTACT_NUMBER AS contactNumber,
	        EMAIL AS email,
	        DIV.DIVISION_ID AS divisionId,
	        DIV.DIVISION_NAME AS divisionName,
	        POS.POSITION_ID AS positionId,
	        POS.POSITION_NAME AS positionName,
	        MANAGER.EMPLOYEE_ID AS managerId,
	        MANAGER.EMPLOYEE_NAME AS managerName,
	         RE.RESIGN_DATE AS resignDate,
	         RE.RESIGN_NOTE AS resignNote
        FROM EMPLOYEES EMP 
        LEFT JOIN DIVISIONS DIV ON DIV.DIVISION_ID = EMP.DIVISION_ID
        JOIN POSITIONS POS ON POS.POSITION_ID = EMP.POSITION_ID
        LEFT JOIN (
        	SELECT EMPLOYEE_ID, EMPLOYEE_NAME FROM EMPLOYEES
        ) MANAGER ON MANAGER.EMPLOYEE_ID = EMP.HEAD_ID
        LEFT JOIN (
		    SELECT EMPLOYEE_ID, RESIGN_DATE, RESIGN_NOTE FROM RESIGN_EMPLOYEES
		)RE ON RE.EMPLOYEE_ID = EMP.EMPLOYEE_ID
        WHERE EMP.EMPLOYEE_ID=#id#
	</select>
	
	<select id="getWeekend"  resultClass="prime.admin.employee.EmployeeBean" parameterClass="java.lang.Integer">
		SELECT 
	        START_FROM AS startFrom,
	        WEEKEND AS weekEnd,
	        WEEKEND_NOTE AS descriptionWeekEnd
	    FROM WEEKEND_HOLIDAYS WH 
        WHERE WH.EMPLOYEE_ID=#id#
	</select>
	
	<select id="getEmployeeWeekendByIdAndStartFrom"  resultClass="prime.admin.employee.EmployeeBean" parameterClass="java.util.Map">
		SELECT 
	        START_FROM AS startFrom,
	        WEEKEND AS weekEnd,
	        WEEKEND_NOTE AS descriptionWeekEnd,
	        EMP.EMPLOYEE_ID AS employeeId,
	        EMPLOYEE_NAME AS employeeName
        FROM WEEKEND_HOLIDAYS WH 
        JOIN EMPLOYEES EMP ON WH.EMPLOYEE_ID = EMP.EMPLOYEE_ID
        WHERE WH.EMPLOYEE_ID=#id# AND TO_CHAR(WH.START_FROM, 'yyyy-mm-dd') = #startFrom#
	</select>
	
	<select id="getDayoff"  resultClass="prime.admin.employee.EmployeeBean" parameterClass="java.lang.Integer">
		SELECT 
	        DAYOFF_START_DATE AS startDate,
	        DAYOFF_END_DATE AS endDate,
	        DAYOFF_NOTE as descriptionDayOff
        FROM DAY_OFFS DO 
        WHERE DO.EMPLOYEE_ID=#id#
	</select>
	
	<select id="getListByColumn" resultClass="prime.admin.employee.EmployeeBean" parameterClass="java.util.Map">
		SELECT * FROM  (SELECT page.*, ROWNUM rnum FROM 
		(SELECT 
		    EMP.EMPLOYEE_ID AS employeeId, 
		    EMP.EMPLOYEE_NAME AS employeeName,
		    GENDER AS gender,
		    ADDRESS AS address,
		    BIRTHDATE AS birthdate,
		    HIRE_DATE AS hireDate,
		    CONTACT_NUMBER AS contactNumber,
		    EMAIL AS email,
		    DIVISION_NAME AS divisionName,
		    POSITION_NAME AS positionName,
		    MANAGER.EMPLOYEE_NAME AS managerName,
		    RE.RESIGN_DATE AS resignDate
		FROM EMPLOYEES EMP 
		LEFT JOIN DIVISIONS DIV ON DIV.DIVISION_ID = EMP.DIVISION_ID
		JOIN POSITIONS POS ON POS.POSITION_ID = EMP.POSITION_ID
		LEFT JOIN (
		    SELECT E.EMPLOYEE_ID, E.EMPLOYEE_NAME FROM EMPLOYEES E
		) MANAGER ON MANAGER.EMPLOYEE_ID = EMP.HEAD_ID
		LEFT JOIN (
		    SELECT EMPLOYEE_ID, RESIGN_DATE FROM RESIGN_EMPLOYEES
		)RE ON RE.EMPLOYEE_ID = EMP.EMPLOYEE_ID
	    <dynamic prepend="WHERE">
	        <isNotNull property="columnSearch">
		       	<isEqual property="columnSearch" compareValue="NAME">
			          UPPER(EMP.EMPLOYEE_NAME) LIKE UPPER('%'||#value#||'%')
				</isEqual> 
	        </isNotNull>
	    </dynamic>
	    ORDER BY EMP.EMPLOYEE_ID ASC) page 
	    WHERE ROWNUM <![CDATA[ <= ]]> #endRow#) WHERE rnum <![CDATA[ >= ]]> #startRow#
	</select>
	
	<select id="getCountByColumn" resultClass="java.lang.Integer" parameterClass="java.util.Map">
		SELECT COUNT(1) 
		FROM EMPLOYEES 
	    <dynamic prepend="WHERE">
	        <isNotNull property="columnSearch">
		       	<isEqual property="columnSearch" compareValue="NAME">
			          UPPER(EMPLOYEE_NAME) LIKE UPPER('%'||#value#||'%')
				</isEqual> 
	        </isNotNull>
	    </dynamic>
	</select>
	
	<select id="getListByColumnAndDivision" resultClass="prime.admin.employee.EmployeeBean" parameterClass="java.util.Map">
		SELECT * FROM  (SELECT page.*, ROWNUM rnum FROM 
		(SELECT 
        EMP.EMPLOYEE_ID AS employeeId, 
        EMP.EMPLOYEE_NAME AS employeeName,
        GENDER AS gender,
        ADDRESS AS address,
        BIRTHDATE AS birthdate,
        CONTACT_NUMBER AS contactNumber,
        EMAIL AS email,
        DIVISION_NAME AS divisionName,
        POSITION_NAME AS positionName,
        <!-- EMPLOYEE_LEVEL AS employeeLevel, -->
        MANAGER.EMPLOYEE_NAME AS managerName
        FROM EMPLOYEES EMP 
        INNER JOIN DIVISIONS DIV ON DIV.DIVISION_ID = EMP.DIVISION_ID
        INNER JOIN POSITIONS POS ON POS.POSITION_ID = EMP.POSITION_ID
        LEFT JOIN (SELECT EMPLOYEE_ID, EMPLOYEE_NAME FROM EMPLOYEES) MANAGER ON MANAGER.EMPLOYEE_ID = EMP.HEAD_ID
		WHERE 1=1 AND  DIV.DIVISION_ID = #divisionId#  
		<dynamic prepend="AND">
	        <isNotNull property="columnSearch">
		       	<isEqual property="columnSearch" compareValue="NAME">
					UPPER(EMPLOYEE_NAME) LIKE UPPER('%'||#value#||'%')
				</isEqual> 
	        </isNotNull>
	    </dynamic>
	    ORDER BY EMP.EMPLOYEE_ID ASC) page 
	    WHERE ROWNUM <![CDATA[ <= ]]> #endRow#) WHERE rnum <![CDATA[ >= ]]> #startRow#
	</select>
	
	<select id="getCountByColumnAndDivision" resultClass="java.lang.Integer" parameterClass="java.util.Map">
		SELECT COUNT(1) 
		FROM EMPLOYEES EMP 
        INNER JOIN DIVISIONS DIV ON DIV.DIVISION_ID = EMP.DIVISION_ID
        INNER JOIN POSITIONS POS ON POS.POSITION_ID = EMP.POSITION_ID
        LEFT JOIN (SELECT EMPLOYEE_ID, EMPLOYEE_NAME FROM EMPLOYEES) MANAGER ON MANAGER.EMPLOYEE_ID = EMP.HEAD_ID
        WHERE  1=1 AND DIV.DIVISION_ID = #divisionId# 
	    <dynamic prepend="AND">
	        <isNotNull property="columnSearch">
		       	<isEqual property="columnSearch" compareValue="NAME">
			         UPPER(EMPLOYEE_NAME) LIKE UPPER('%'||#value#||'%')
				</isEqual> 
	        </isNotNull>
	    </dynamic>
	</select>
	
	<select id="getCountByColumnEmployeeHead" resultClass="java.lang.Integer" parameterClass="java.util.Map">
		SELECT COUNT(1) 
		FROM EMPLOYEES EMP
		JOIN DIVISIONS DIV ON DIV.DIVISION_ID = EMP.DIVISION_ID
		JOIN POSITIONS POS ON POS.POSITION_ID = EMP.POSITION_ID
		LEFT JOIN (
		    SELECT E.EMPLOYEE_ID, E.EMPLOYEE_NAME, MGRDIV.DIVISION_ID AS DIVISION_ID FROM EMPLOYEES E
		    JOIN DIVISIONS MGRDIV ON MGRDIV.DIVISION_ID = E.DIVISION_ID
		) MANAGER ON MANAGER.EMPLOYEE_ID = EMP.HEAD_ID
		WHERE 1=1
		<dynamic prepend="AND">
	        <isEqual property="paramCondition" compareValue="employeeAdd">
				POS.POSITION_LEVEL <![CDATA[ < ]]> #positionLevel# AND EMP.EMPLOYEE_ID != #employeeId#
			</isEqual>
			<isEqual property="paramCondition" compareValue="employeeResign">
				POS.POSITION_LEVEL <![CDATA[ <= ]]> #positionLevel#  AND EMP.EMPLOYEE_ID != #employeeId#
			</isEqual>
		</dynamic>
	    <dynamic prepend="AND">
	        <isNotNull property="columnSearch">
		       	<isEqual property="columnSearch" compareValue="NAME">
			          UPPER(EMPLOYEE_NAME) LIKE UPPER('%'||#value#||'%')
				</isEqual> 
	        </isNotNull>
	    </dynamic>
	</select>
	
	<select id="getListEmployeeHead" resultClass="prime.admin.employee.EmployeeBean" parameterClass="java.util.Map">
		SELECT * FROM  (SELECT page.*, ROWNUM rnum FROM 
		(SELECT 
		    EMP.EMPLOYEE_ID AS employeeId, 
		    EMP.EMPLOYEE_NAME AS employeeName,
		    GENDER AS gender,
		    ADDRESS AS address,
		    BIRTHDATE AS birthdate,
		    HIRE_DATE AS hireDate,
		    CONTACT_NUMBER AS contactNumber,
		    EMAIL AS email,
		    DIVISION_NAME AS divisionName,
		    POSITION_NAME AS positionName,
		    MANAGER.EMPLOYEE_NAME AS managerName,
		    MANAGER.DIVISION_ID AS divisionId
		FROM EMPLOYEES EMP 
		JOIN DIVISIONS DIV ON DIV.DIVISION_ID = EMP.DIVISION_ID
		JOIN POSITIONS POS ON POS.POSITION_ID = EMP.POSITION_ID
		LEFT JOIN (
		    SELECT E.EMPLOYEE_ID, E.EMPLOYEE_NAME, MGRDIV.DIVISION_ID AS DIVISION_ID FROM EMPLOYEES E
		    JOIN DIVISIONS MGRDIV ON MGRDIV.DIVISION_ID = E.DIVISION_ID
		) MANAGER ON MANAGER.EMPLOYEE_ID = EMP.HEAD_ID
		WHERE 1=1
		<dynamic prepend="AND">
	        <isEqual property="paramCondition" compareValue="employeeAdd">
				POS.POSITION_LEVEL <![CDATA[ < ]]> #positionLevel# AND EMP.EMPLOYEE_ID != #employeeId#
			</isEqual>
			<isEqual property="paramCondition" compareValue="employeeResign">
				POS.POSITION_LEVEL <![CDATA[ <= ]]> #positionLevel# AND EMP.EMPLOYEE_ID != #employeeId# 
			</isEqual>
		</dynamic>
	    <dynamic prepend="AND">
	        <isNotNull property="columnSearch">
		       	<isEqual property="columnSearch" compareValue="NAME">
			          UPPER(EMP.EMPLOYEE_NAME) LIKE UPPER('%'||#value#||'%')
				</isEqual> 
	        </isNotNull>
	    </dynamic>
	    ORDER BY EMP.EMPLOYEE_ID ASC) page 
	    WHERE ROWNUM <![CDATA[ <= ]]> #endRow#) WHERE rnum <![CDATA[ >= ]]> #startRow#
	</select>
</sqlMap>
